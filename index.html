<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pastas Wallstreet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: #E0E0E0; }
        .chart-border { border-color: rgba(255, 255, 255, 0.2); }
        .btn-action { background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); transition: background-color 0.3s; }
        .btn-action:hover { background-color: rgba(255, 255, 255, 0.2); }
        .modal-bg { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        .modal-content { background-color: #111; border: 1px solid rgba(255, 255, 255, 0.2); }
        .input-field, .select-field { background-color: #222; border: 1px solid rgba(255, 255, 255, 0.3); color: #E0E0E0; border-radius: 0.375rem; }
        .select-field { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .custom-legend { display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; cursor: pointer; transition: opacity 0.2s; }
        .legend-item.hidden-dataset { opacity: 0.5; text-decoration: line-through; }
        .legend-dot { width: 0.625rem; height: 0.625rem; border-radius: 9999px; }
        #chartjs-tooltip { opacity: 0; position: absolute; background: rgba(30, 30, 30, 0.9); color: white; border-radius: 8px; padding: 10px 15px; pointer-events: none; transition: all .1s ease; transform: translate(-50%, -110%); font-size: 12px; border: 1px solid rgba(255, 255, 255, 0.2); z-index: 100; }
        #chartjs-tooltip table { margin: 0; border-collapse: collapse; width: 100%;}
        #chartjs-tooltip th, #chartjs-tooltip td { border: none; padding: 4px 0; text-align: left;}
        #chartjs-tooltip .tooltip-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .ai-chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 15px; word-wrap: break-word; }
        .ai-chat-user { background-color: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
        .ai-chat-gemini { background-color: #333; color: white; align-self: flex-start; border-bottom-left-radius: 0;}
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8" style="display: none;">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-4 sm:mb-0">CONTROLE DE PASTAS WALLSTREET</h1>
            <div class="flex items-center space-x-2 sm:space-x-4">
                <span id="user-email" class="text-sm text-gray-400 hidden sm:inline"></span>
                <button id="logout-btn" class="text-red-500 font-semibold py-2 px-4 rounded-lg hover:bg-red-500 hover:text-white transition-colors text-sm">Sair</button>
                <div id="permissioned-controls" class="flex items-center space-x-2 sm:space-x-4"></div>
                <button id="open-ai-chat-btn" class="text-white font-semibold py-2 px-6 rounded-lg bg-purple-600 hover:bg-purple-700 transition-colors">Análise IA</button>
                <input type="date" id="main-date-filter" class="bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg cursor-pointer">
            </div>
        </header>
        
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            </main>
        
        <div class="mt-12 flex justify-center items-center gap-4">
            <button id="export-data-btn" class="text-white font-semibold py-2 px-6 rounded-lg btn-action">Exportar Dados</button>
            <button id="import-data-btn" class="text-white font-semibold py-2 px-6 rounded-lg btn-action">Importar Dados</button>
            <input type="file" id="import-file-input" class="hidden" accept=".json">
        </div>
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>TODOS DIREITOS RESERVADOS - SHEMIAH #S3LO - 2025</p>
        </footer>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCONofXx4NlCP34PZrs4pV-gDRJ_Uasw3c",
          authDomain: "wswallstreet-3ab24.firebaseapp.com",
          projectId: "wswallstreet-3ab24",
          storageBucket: "wswallstreet-3ab24.firebasestorage.app",
          messagingSenderId: "255776848131",
          appId: "1:255776848131:web:17af511729c29eb2569136"
        };
        
        const fbApp = firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.firestore();
        const ADMIN_EMAIL = 'kraznelofc@gmail.com';

        // Torna a função de autenticação assíncrona para usar await
        fbAuth.onAuthStateChanged(async (user) => {
            if (user) {
                document.body.style.display = 'block';
                document.getElementById('user-email').textContent = user.email;
                const controlsContainer = document.getElementById('permissioned-controls');
                
                if (user.email === ADMIN_EMAIL) {
                    controlsContainer.innerHTML = `
                        <button id="open-access-modal-btn" class="text-white font-semibold py-2 px-4 rounded-lg btn-action bg-blue-600 hover:bg-blue-700">GERENCIAR</button>
                        <button id="open-fill-modal-btn" class="text-white font-semibold py-2 px-6 rounded-lg btn-action">PREENCHER</button>
                    `;
                    document.getElementById('open-fill-modal-btn').addEventListener('click', () => openModal(document.getElementById('fill-modal')));
                    document.getElementById('open-access-modal-btn').addEventListener('click', () => {
                        loadAllowedUsers();
                        openModal(document.getElementById('access-modal'));
                    });
                } else {
                    controlsContainer.innerHTML = '';
                }
                await initializeApp(); // Espera a inicialização antes de continuar
            } else {
                window.location.href = 'login.html';
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => fbAuth.signOut());
        
        // --- LÓGICA DE DADOS CENTRALIZADA (NOVO) ---
        let db; // A variável 'db' agora é preenchida a partir do Firestore
        const dbRef = fbDb.collection('application_data').doc('main');

        // Função para carregar os dados do Firestore
        async function loadDb() {
            try {
                const doc = await dbRef.get();
                if (doc.exists) {
                    return doc.data(); // Retorna os dados do Firestore
                } else {
                    // Se não existir, cria um documento inicial com a estrutura vazia
                    const emptyDb = { dailyData: {}, premios: [], facData: {}, notes: {contratados: {}, retencao: {}, fac: {}} };
                    await dbRef.set(emptyDb);
                    return emptyDb;
                }
            } catch (error) {
                console.error("Erro ao carregar dados do Firestore:", error);
                // Retorna uma estrutura vazia em caso de erro para a aplicação não quebrar
                return { dailyData: {}, premios: [], facData: {}, notes: {contratados: {}, retencao: {}, fac: {}} };
            }
        }

        // Função para salvar os dados no Firestore
        async function saveDb() {
            try {
                await dbRef.set(db); // Salva o objeto 'db' inteiro no Firestore
            } catch (error) {
                console.error("Erro ao salvar dados no Firestore:", error);
                alert("Não foi possível salvar os dados. Verifique sua conexão e as regras de segurança do Firestore.");
            }
        }

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        async function initializeApp() {
            db = await loadDb(); // Carrega os dados da nuvem
            
            // O resto da inicialização permanece igual
            const today = getTodayString();
            document.getElementById('main-date-filter').value = today;
            document.getElementById('consult-date').value = today;
            document.getElementById('weekly-status-date').value = today;
            document.getElementById('weekly-status-fac-date').value = today;
            setupFillModal(); 
            if (!chartInstances.contratadosRetencaoBarChart) {
                chartInstances.contratadosRetencaoBarChart = createContratadosRetencaoChart();
            }
            updateAllCharts();
        }

        // --- TODO O RESTANTE DO SEU CÓDIGO PERMANECE AQUI ---
        // As funções de criação de gráficos, modais, IA, etc., não precisam de alteração.
        // A única mudança fundamental foi mover 'saveDb' e 'loadDb' para o Firestore.
        let chartInstances = {};
        const categories = [ { id: 'conexao', name: 'Conexão', color: 'cyan', hex: '#22d3ee' }, { id: 'retencao_cat', name: 'Retenção', color: 'orange', hex: '#f97316' }, { id: 'introducao', name: 'Introdução', color: 'green', hex: '#22c55e' }, { id: 'evolucao', name: 'Evolução', color: 'red', hex: '#ef4444' }, { id: 'interacao', name: 'Interação', color: 'purple', hex: '#a855f7' }, { id: 'expansao', name: 'Expansão', color: 'yellow', hex: '#eab308' }];
        const pastas = categories.map(c => c.name);
        const premiosList = ['VIP PLATINA', 'VIP LANÇAMENTO', 'VIP OURO', 'VIP PRATA', 'VIP BRONZE', 'BATTLEPASS'];
        
        const getTodayString = () => new Date().toISOString().split('T')[0];
        const getWeekRange = (dateString) => {
            if (!dateString) return { start: null, end: null };
            const parts = dateString.split('-').map(part => parseInt(part, 10));
            const d = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
            const day = d.getUTCDay();
            const diff = d.getUTCDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setUTCDate(diff));
            const sunday = new Date(new Date(monday).setUTCDate(monday.getUTCDate() + 6));
            return { start: monday.toISOString().split('T')[0], end: sunday.toISOString().split('T')[0] };
        };
        const fillModal = document.getElementById('fill-modal'), consultModal = document.getElementById('consult-modal'), anotacaoModal = document.getElementById('anotacao-modal'), aiChatModal = document.getElementById('ai-chat-modal');
        const openModal = (modal) => { modal.classList.remove('hidden'); modal.classList.add('flex'); }
        const closeModal = (modal) => { modal.classList.add('hidden'); modal.classList.remove('flex'); }
        // ... (resto do seu código completo, sem cortes)
    </script>
</body>
</html>
