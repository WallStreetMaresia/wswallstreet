<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pastas Wallstreet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: #E0E0E0; }
        .chart-border { border-color: rgba(255, 255, 255, 0.2); }
        .btn-action { background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); transition: background-color 0.3s; }
        .btn-action:hover { background-color: rgba(255, 255, 255, 0.2); }
        .modal-bg { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        .modal-content { background-color: #111; border: 1px solid rgba(255, 255, 255, 0.2); }
        .input-field, .select-field { background-color: #222; border: 1px solid rgba(255, 255, 255, 0.3); color: #E0E0E0; border-radius: 0.375rem; }
        .select-field { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .custom-legend { display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; cursor: pointer; transition: opacity 0.2s; }
        .legend-item.hidden-dataset { opacity: 0.5; text-decoration: line-through; }
        .legend-dot { width: 0.625rem; height: 0.625rem; border-radius: 9999px; }
        .day-btn.active { background-color: #facc15; color: #111827; font-weight: bold; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8" style="display: none;">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-4 sm:mb-0">CONTROLE DE PASTAS WALLSTREET</h1>
            <div class="flex items-center space-x-2 sm:space-x-4">
                <span id="user-email" class="text-sm text-gray-400 hidden sm:inline"></span>
                <button id="logout-btn" class="text-red-500 font-semibold py-2 px-4 rounded-lg hover:bg-red-500 hover:text-white transition-colors text-sm">Sair</button>
                <div id="permissioned-controls" class="flex items-center space-x-2 sm:space-x-4"></div>
                <input type="date" id="main-date-filter" class="bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg cursor-pointer">
            </div>
        </header>
        
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="border chart-border rounded-xl p-6 flex flex-col">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4" id="controls-contratados"><h2 class="text-lg font-semibold text-white">LINHA DO TEMPO - CONTRATADOS</h2><div class="flex items-center space-x-2"><input type="date" class="input-field p-1 text-sm compare-start-date" title="Data Início"><input type="date" class="input-field p-1 text-sm compare-end-date" title="Data Fim"><button class="text-white border border-gray-500 rounded-lg py-1 px-3 text-sm font-semibold btn-action btn-reset-chart">RESET</button></div></div>
                <div class="relative flex-grow h-64"><canvas id="contratados-timeline-chart"></canvas></div>
            </div>
            <div class="border chart-border rounded-xl p-6 flex flex-col">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4" id="controls-retencao"><h2 class="text-lg font-semibold text-white">LINHA DO TEMPO - RETENÇÃO</h2><div class="flex items-center space-x-2"><input type="date" class="input-field p-1 text-sm compare-start-date" title="Data Início"><input type="date" class="input-field p-1 text-sm compare-end-date" title="Data Fim"><button class="text-white border border-gray-500 rounded-lg py-1 px-3 text-sm font-semibold btn-action btn-reset-chart">RESET</button></div></div>
                <div class="relative flex-grow h-64"><canvas id="retencao-timeline-chart"></canvas></div>
            </div>
            <div class="lg:col-span-2 border chart-border rounded-xl p-6 flex flex-col">
                <h2 class="text-lg font-semibold text-white mb-2 text-center">CONTRATADOS X RETENÇÃO</h2>
                <div id="bar-chart-day-buttons" class="flex justify-center items-center flex-wrap gap-2 mb-4"></div>
                <div id="comparison-indicators" class="flex justify-center flex-wrap gap-4 mb-4"></div>
                <div class="relative flex-grow h-64"><canvas id="contratados-retencao-bar-chart"></canvas></div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
              apiKey: "AIzaSyCONofXx4NlCP34PZrs4pV-gDRJ_Uasw3c",
              authDomain: "wswallstreet-3ab24.firebaseapp.com",
              projectId: "wswallstreet-3ab24",
              storageBucket: "wswallstreet-3ab24.firebasestorage.app",
              messagingSenderId: "255776848131",
              appId: "1:255776848131:web:17af511729c29eb2569136"
            };
            
            const fbApp = firebase.initializeApp(firebaseConfig);
            const fbAuth = firebase.auth();
            const fbDb = firebase.firestore();
            const ADMIN_EMAIL = 'kraznelofc@gmail.com';

            fbAuth.onAuthStateChanged(async (user) => {
                if (user) {
                    document.body.style.display = 'block';
                    const controlsContainer = document.getElementById('permissioned-controls');
                    if (user.email === ADMIN_EMAIL) {
                        controlsContainer.innerHTML = `<button id="open-fill-modal-btn" class="text-white font-semibold py-2 px-6 rounded-lg btn-action">PREENCHER</button>`;
                    } else {
                        controlsContainer.innerHTML = '';
                    }
                    await initializeApp();
                } else {
                    window.location.href = 'login.html';
                }
            });

            let db;
            const dbRef = fbDb.collection('application_data').doc('main');

            async function loadDb() {
                try {
                    const doc = await dbRef.get();
                    if (doc.exists && doc.data().dailyData) {
                        return doc.data();
                    }
                    return { dailyData: {}, premios: [], facData: {}, notes: {} };
                } catch (error) {
                    console.error("Erro fatal ao carregar dados do Firestore:", error);
                    document.body.innerHTML = '<div style="color:white; text-align:center; padding-top: 50px;"><h1>Erro Crítico</h1><p>Não foi possível carregar os dados do painel. Verifique sua conexão e o console de erros.</p></div>';
                    document.body.style.display = 'block';
                    return null;
                }
            }

            async function initializeApp() {
                db = await loadDb();
                if (!db) return;

                const today = new Date().toISOString().split('T')[0];
                document.getElementById('main-date-filter').value = today;

                setupDayButtons();
                setupAutoCompareInputs();
                
                chartInstances.contratadosTimelineChart = createTimelineChart('contratados-timeline-chart', 'contratados');
                chartInstances.retencaoTimelineChart = createTimelineChart('retencao-timeline-chart', 'retencao');
                chartInstances.contratadosRetencaoBarChart = createContratadosRetencaoChart();
                
                updateContratadosRetencaoChart(today);
            }

            let chartInstances = {};
            const categories = [ { id: 'conexao', name: 'Conexão'}, { id: 'retencao_cat', name: 'Retenção' }, { id: 'introducao', name: 'Introdução'}, { id: 'evolucao', name: 'Evolução' }, { id: 'interacao', name: 'Interação' }, { id: 'expansao', name: 'Expansão' }];
            const categoryColors = { 'Conexão': '#22d3ee', 'Retenção': '#f97316', 'Introdução': '#22c55e', 'Evolução': '#ef4444', 'Interação': '#a855f7', 'Expansão': '#eab308' };

            const createTimelineChart = (canvasId, dataKey) => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                const sortedDates = Object.keys(db.dailyData || {}).sort();
                const datasets = categories.map(cat => ({
                    label: cat.name,
                    data: sortedDates.map(date => ({ x: date, y: db.dailyData[date]?.[cat.id]?.[dataKey] || 0 })),
                    borderColor: categoryColors[cat.name],
                    backgroundColor: categoryColors[cat.name],
                    fill: false,
                    tension: 0.1
                }));
                return new Chart(ctx, { type: 'line', data: { datasets }, options: { maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } } } } });
            };

            const createContratadosRetencaoChart = () => {
                const ctx = document.getElementById('contratados-retencao-bar-chart').getContext('2d');
                return new Chart(ctx, 'bar', {
                    data: {
                        labels: categories.map(c => c.name),
                        datasets: [
                            { label: 'Contratados', data: [], backgroundColor: '#22d3ee' },
                            { label: 'Retenção', data: [], backgroundColor: '#f97316' }
                        ]
                    },
                    options: { maintainAspectRatio: false }
                });
            };

            const updateContratadosRetencaoChart = (date) => {
                updateComparisonIndicators(date); 
                const dataForDay = db.dailyData?.[date] || {};
                const chart = chartInstances.contratadosRetencaoBarChart;
                if (chart) {
                    chart.data.datasets[0].data = categories.map(cat => dataForDay[cat.id]?.contratados || 0);
                    chart.data.datasets[1].data = categories.map(cat => dataForDay[cat.id]?.retencao || 0);
                    chart.update();
                }
                updateActiveDayButton(date);
            };
            
            const updateComparisonIndicators = (dateString) => {
                const container = document.getElementById('comparison-indicators');
                container.innerHTML = '';
                if (!dateString || !db.dailyData) return;

                const currentDataForDay = db.dailyData[dateString];
                if (!currentDataForDay) {
                    container.innerHTML = `<div class="text-sm text-gray-500 italic">Aguardando dados para o cálculo.</div>`;
                    return;
                }
                const currentDate = new Date(`${dateString}T12:00:00`);
                const previousWeekDate = new Date(currentDate);
                previousWeekDate.setDate(currentDate.getDate() - 7);
                const previousWeekDateString = previousWeekDate.toISOString().split('T')[0];
                const previousData = db.dailyData[previousWeekDateString] || {};
                const totals = { current: { contratados: 0, retencao: 0 }, previous: { contratados: 0, retencao: 0 }};
                categories.forEach(cat => {
                    totals.current.contratados += currentDataForDay[cat.id]?.contratados || 0;
                    totals.current.retencao += currentDataForDay[cat.id]?.retencao || 0;
                    totals.previous.contratados += previousData[cat.id]?.contratados || 0;
                    totals.previous.retencao += previousData[cat.id]?.retencao || 0;
                });
                const createIndicator = (label, currentValue, previousValue) => { let percentage = 0; if (previousValue > 0) { percentage = ((currentValue - previousValue) / previousValue) * 100; } else if (currentValue > 0) { percentage = 100; } const roundedPercentage = Math.round(percentage); const color = roundedPercentage >= 0 ? 'green' : 'red'; const arrow = roundedPercentage >= 0 ? '↑' : '↓'; return `<div class="flex items-center gap-2 p-2 px-3 rounded-md text-white text-xs font-semibold bg-${color}-900/50 border border-${color}-500"><span>${label}:</span><span class="font-bold text-${color}-400">${arrow} ${Math.abs(roundedPercentage)}% referente a 7 dias atrás</span></div>`; };
                container.innerHTML = createIndicator('Contratados', totals.current.contratados, totals.previous.contratados) + createIndicator('Retenção', totals.current.retencao, totals.previous.retencao);
            };
            
            const setupDayButtons = () => {
                const container = document.getElementById('bar-chart-day-buttons');
                const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
                const dayIndices = [1, 2, 3, 4, 5, 6, 0];
                container.innerHTML = days.map((day, index) => `<button class="day-btn px-3 py-1 text-xs rounded-md btn-action" data-day-index="${dayIndices[index]}">${day}</button>`).join('');
                
                container.addEventListener('click', (e) => {
                    if (e.target.classList.contains('day-btn')) {
                        const mainDateVal = document.getElementById('main-date-filter').value;
                        if (!mainDateVal) return;
                        
                        const mainDate = new Date(`${mainDateVal}T12:00:00Z`);
                        const targetDayIndex = parseInt(e.target.dataset.dayIndex, 10);
                        
                        // Lógica Definitiva: Acha a segunda-feira da semana e calcula a partir dela
                        const dayOfWeek = mainDate.getUTCDay();
                        const daysToMonday = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;
                        
                        const mondayOfRelevantWeek = new Date(mainDate);
                        mondayOfRelevantWeek.setUTCDate(mondayOfRelevantWeek.getUTCDate() - daysToMonday);
                        
                        const dayOffset = dayIndices.indexOf(targetDayIndex);
                        
                        const targetDate = new Date(mondayOfRelevantWeek);
                        targetDate.setUTCDate(targetDate.getUTCDate() + dayOffset);

                        const targetDateString = targetDate.toISOString().split('T')[0];
                        updateContratadosRetencaoChart(targetDateString);
                    }
                });
            };

            const updateActiveDayButton = (dateString) => {
                const container = document.getElementById('bar-chart-day-buttons');
                container.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
                if (dateString) {
                    const date = new Date(`${dateString}T12:00:00Z`);
                    const dayIndex = date.getUTCDay();
                    const activeButton = container.querySelector(`[data-day-index="${dayIndex}"]`);
                    if (activeButton) {
                        activeButton.classList.add('active');
                    }
                }
            };
            
            const setupAutoCompareInputs = () => {
                ['contratados', 'retencao'].forEach(key => {
                    const controlDiv = document.getElementById(`controls-${key}`);
                    const startDateInput = controlDiv.querySelector('.compare-start-date');
                    const endDateInput = controlDiv.querySelector('.compare-end-date');
                    const chart = chartInstances[`${key}TimelineChart`];
                    
                    const applyFilter = () => {
                        const start = startDateInput.value;
                        const end = endDateInput.value;
                        if (chart && start && end && end >= start) {
                            chart.options.scales.x.min = start;
                            chart.options.scales.x.max = end;
                            chart.update();
                        }
                    };
                    startDateInput.addEventListener('change', applyFilter);
                    endDateInput.addEventListener('change', applyFilter);
                });
            };
            
            document.querySelectorAll('.btn-reset-chart').forEach(btn => btn.addEventListener('click', (e) => {
                const controlsDiv = e.target.closest('[id^="controls-"]');
                controlsDiv.querySelector('.compare-start-date').value = '';
                controlsDiv.querySelector('.compare-end-date').value = '';
                const key = controlsDiv.id.split('-')[1];
                const chart = chartInstances[`${key}TimelineChart`];
                if (chart) {
                    delete chart.options.scales.x.min;
                    delete chart.options.scales.x.max;
                    chart.update();
                }
            }));

            document.getElementById('main-date-filter').addEventListener('change', (e) => {
                updateContratadosRetencaoChart(e.target.value);
            });
        });
    </script>
</body>
</html>
