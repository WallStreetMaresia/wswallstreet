<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pastas Wallstreet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... todos os seus estilos ... */
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8" style="display: none;">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-4 sm:mb-0">CONTROLE DE PASTAS WALLSTREET</h1>
            <div class="flex items-center space-x-2 sm:space-x-4">
                <span id="user-email" class="text-sm text-gray-400 hidden sm:inline"></span>
                <button id="logout-btn" class="text-red-500 font-semibold py-2 px-4 rounded-lg hover:bg-red-500 hover:text-white transition-colors text-sm">Sair</button>
                
                <div id="permissioned-controls" class="flex items-center space-x-2 sm:space-x-4"></div>
                
                <button id="open-ai-chat-btn" class="text-white font-semibold py-2 px-6 rounded-lg bg-purple-600 hover:bg-purple-700 transition-colors">Análise IA</button>
                <input type="date" id="main-date-filter" class="bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg cursor-pointer">
            </div>
        </header>

        <main>
            </main>
        <footer>
            </footer>
    </div>
    
    <div id="fill-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-50">
        </div>
    <div id="access-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-50">
        <div class="modal-content rounded-xl p-8 w-full max-w-lg">
            <h2 class="text-xl font-bold text-white mb-6">Gerenciar Acessos</h2>
            
            <div class="mb-6">
                <label for="new-email-input" class="block text-sm font-medium text-gray-300 mb-2">Adicionar novo e-mail</label>
                <div class="flex gap-2">
                    <input type="email" id="new-email-input" class="w-full p-2 input-field" placeholder="email.membro@exemplo.com">
                    <button id="add-email-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Adicionar</button>
                </div>
                 <p id="access-error-message" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>

            <h3 class="text-lg font-semibold text-white mb-4">E-mails com Acesso:</h3>
            <div id="access-list-container" class="space-y-2 max-h-[40vh] overflow-y-auto">
                <p class="text-gray-400">Carregando...</p>
            </div>

            <div class="flex justify-end mt-8">
                <button id="close-access-modal-btn" class="py-2 px-6 rounded-lg btn-action">Fechar</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCONofXx4NlCP34PZrs4pV-gDRJ_Uasw3c",
          authDomain: "wswallstreet-3ab24.firebaseapp.com",
          projectId: "wswallstreet-3ab24",
          storageBucket: "wswallstreet-3ab24.firebasestorage.app",
          messagingSenderId: "255776848131",
          appId: "1:255776848131:web:17af511729c29eb2569136"
        };
        
        const fbApp = firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.firestore();
        const ADMIN_EMAIL = 'kraznelofc@gmail.com';

        // Lógica de Permissão
        fbAuth.onAuthStateChanged(user => {
            if (user) {
                document.body.style.display = 'block';
                document.getElementById('user-email').textContent = user.email;
                
                const controlsContainer = document.getElementById('permissioned-controls');
                
                if (user.email === ADMIN_EMAIL) {
                    controlsContainer.innerHTML = `
                        <button id="open-access-modal-btn" class="text-white font-semibold py-2 px-6 rounded-lg btn-action bg-blue-600 hover:bg-blue-700">GERENCIAR</button>
                        <button id="open-fill-modal-btn" class="text-white font-semibold py-2 px-6 rounded-lg btn-action">PREENCHER</button>
                    `;
                    // Adiciona eventos aos botões de admin
                    document.getElementById('open-fill-modal-btn').addEventListener('click', () => openModal(document.getElementById('fill-modal')));
                    document.getElementById('open-access-modal-btn').addEventListener('click', () => {
                        loadAllowedUsers();
                        openModal(document.getElementById('access-modal'));
                    });
                } else {
                    controlsContainer.innerHTML = ''; // Membros não veem os botões
                }
                initializeApp();
            } else {
                window.location.href = 'login.html';
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => fbAuth.signOut());

        // --- LÓGICA DO MODAL DE ACESSOS (NOVO) ---
        const accessModal = document.getElementById('access-modal');
        const accessListContainer = document.getElementById('access-list-container');
        const newEmailInput = document.getElementById('new-email-input');
        const addEmailBtn = document.getElementById('add-email-btn');
        const accessErrorMsg = document.getElementById('access-error-message');
        const allowedUsersRef = fbDb.collection('permissions').doc('allowed_users');

        document.getElementById('close-access-modal-btn').addEventListener('click', () => closeModal(accessModal));

        async function loadAllowedUsers() {
            accessListContainer.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            try {
                const doc = await allowedUsersRef.get();
                if (doc.exists) {
                    const emails = doc.data().emails || [];
                    const memberEmails = emails.filter(email => email !== ADMIN_EMAIL);
                    
                    if(memberEmails.length === 0) {
                       accessListContainer.innerHTML = '<p class="text-gray-500">Nenhum membro adicionado.</p>';
                       return;
                    }
                    
                    accessListContainer.innerHTML = memberEmails.map(email => `
                        <div class="flex justify-between items-center bg-gray-800 p-2 rounded">
                            <span class="text-gray-300 text-sm">${email}</span>
                            <button class="text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" onclick="removeEmail('${email}')">Remover</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error("Erro ao carregar lista de acesso:", error);
                accessListContainer.innerHTML = '<p class="text-red-500">Não foi possível carregar a lista.</p>';
            }
        }

        addEmailBtn.addEventListener('click', async () => {
            const newEmail = newEmailInput.value.trim().toLowerCase();
            if (!newEmail || !newEmail.includes('@')) {
                accessErrorMsg.textContent = 'Por favor, insira um e-mail válido.';
                return;
            }
            
            addEmailBtn.disabled = true;
            accessErrorMsg.textContent = '';

            try {
                // 'arrayUnion' adiciona o item ao array apenas se ele não existir
                await allowedUsersRef.update({
                    emails: firebase.firestore.FieldValue.arrayUnion(newEmail)
                });
                newEmailInput.value = '';
                await loadAllowedUsers(); // Recarrega a lista para mostrar o novo e-mail
            } catch (error) {
                console.error("Erro ao adicionar e-mail:", error);
                accessErrorMsg.textContent = 'Erro ao salvar. Tente novamente.';
            } finally {
                addEmailBtn.disabled = false;
            }
        });

        async function removeEmail(emailToRemove) {
            if (confirm(`Tem certeza que deseja remover o acesso de ${emailToRemove}?`)) {
                try {
                     // 'arrayRemove' remove todas as instâncias do item do array
                    await allowedUsersRef.update({
                        emails: firebase.firestore.FieldValue.arrayRemove(emailToRemove)
                    });
                    await loadAllowedUsers(); // Recarrega a lista
                } catch (error) {
                     console.error("Erro ao remover e-mail:", error);
                     alert('Não foi possível remover o e-mail.');
                }
            }
        }
        
        // --- TODO O RESTANTE DO SEU CÓDIGO PERMANECE AQUI ---
        // ...
        // (Copie e cole o restante do script de `index.html` aqui, começando com `let db;`, `const categories = ...`, etc. Nada mais precisa ser alterado.)
        // ...

    </script>
</body>
</html>
