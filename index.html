<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pastas Wallstreet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: #E0E0E0; }
        .chart-border { border-color: rgba(255, 255, 255, 0.2); }
        .btn-action { background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); transition: background-color 0.3s; }
        .btn-action:hover { background-color: rgba(255, 255, 255, 0.2); }
        .modal-bg { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        .modal-content { background-color: #111; border: 1px solid rgba(255, 255, 255, 0.2); }
        .input-field, .select-field { background-color: #222; border: 1px solid rgba(255, 255, 255, 0.3); color: #E0E0E0; border-radius: 0.375rem; }
        .select-field { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .custom-legend { display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; cursor: pointer; transition: opacity 0.2s; }
        .legend-item.hidden-dataset { opacity: 0.5; text-decoration: line-through; }
        .legend-dot { width: 0.625rem; height: 0.625rem; border-radius: 9999px; }
        #chartjs-tooltip { opacity: 0; position: absolute; background: rgba(30, 30, 30, 0.9); color: white; border-radius: 8px; padding: 10px 15px; pointer-events: none; transition: all .1s ease; transform: translate(-50%, -110%); font-size: 12px; border: 1px solid rgba(255, 255, 255, 0.2); z-index: 100; }
        #chartjs-tooltip table { margin: 0; border-collapse: collapse; width: 100%;}
        #chartjs-tooltip th, #chartjs-tooltip td { border: none; padding: 4px 0; text-align: left;}
        #chartjs-tooltip .tooltip-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .ai-chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 15px; word-wrap: break-word; }
        .ai-chat-user { background-color: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
        .ai-chat-gemini { background-color: #333; color: white; align-self: flex-start; border-bottom-left-radius: 0;}
        .day-btn.active { background-color: #facc15; color: #111827; font-weight: bold; }
        /* Estilos para o Litepicker */
        .litepicker{ background-color: #1a1a1a; border: 1px solid rgba(255, 255, 255, 0.3); color: #E0E0E0; z-index: 1000 !important; }
        .litepicker .container__months .month-item .month-item-header, .litepicker .container__months .month-item .day-item{ color: #E0E0E0; }
        .litepicker .container__months .month-item .day-item.is-today{ color: #facc15; border: 1px solid #facc15; border-radius: 50%;}
        .litepicker .container__months .month-item .day-item.is-start-date, .litepicker .container__months .month-item .day-item.is-end-date { background-color: #facc15; color: #111827; border-radius: 50%; }
        .litepicker .container__months .month-item .day-item.in-range { background-color: rgba(250, 204, 21, 0.2); border-radius: 0; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8" style="display: none;">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-4 sm:mb-0">CONTROLE DE PASTAS WALLSTREET</h1>
            <div class="flex items-center space-x-2 sm:space-x-4">
                <span id="user-email" class="text-sm text-gray-400 hidden sm:inline"></span>
                <button id="logout-btn" class="text-red-500 font-semibold py-2 px-4 rounded-lg hover:bg-red-500 hover:text-white transition-colors text-sm">Sair</button>
                <div id="permissioned-controls" class="flex items-center space-x-2 sm:space-x-4"></div>
                <button id="open-ai-chat-btn" class="text-white font-semibold py-2 px-6 rounded-lg bg-purple-600 hover:bg-purple-700 transition-colors">Análise IA</button>
                <input type="date" id="main-date-filter" class="bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg cursor-pointer">
            </div>
        </header>
        
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="border chart-border rounded-xl p-6 flex flex-col">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4" id="controls-contratados"><h2 class="text-lg font-semibold text-white">LINHA DO TEMPO - CONTRATADOS</h2><div class="flex items-center space-x-2"><input type="text" readonly class="input-field p-1 text-sm text-center cursor-pointer litepicker-trigger" placeholder="Selecionar Período" style="width: 240px;"><button class="text-purple-400 border border-purple-400 rounded-lg py-1 px-3 text-sm font-semibold hover:bg-purple-400 hover:text-black transition-colors btn-anotacao" data-key="contratados">ANOTAÇÃO</button><button class="text-white border border-gray-500 rounded-lg py-1 px-3 text-sm font-semibold btn-action btn-reset-chart">RESET</button></div></div>
                <div class="relative flex-grow h-64"><canvas id="contratados-timeline-chart"></canvas></div><div id="timeline-contratados-legend" class="custom-legend"></div>
            </div>
            <div class="border chart-border rounded-xl p-6 flex flex-col">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4" id="controls-retencao"><h2 class="text-lg font-semibold text-white">LINHA DO TEMPO - RETENÇÃO</h2><div class="flex items-center space-x-2"><input type="text" readonly class="input-field p-1 text-sm text-center cursor-pointer litepicker-trigger" placeholder="Selecionar Período" style="width: 240px;"><button class="text-purple-400 border border-purple-400 rounded-lg py-1 px-3 text-sm font-semibold hover:bg-purple-400 hover:text-black transition-colors btn-anotacao" data-key="retencao">ANOTAÇÃO</button><button class="text-white border border-gray-500 rounded-lg py-1 px-3 text-sm font-semibold btn-action btn-reset-chart">RESET</button></div></div>
                <div class="relative flex-grow h-64"><canvas id="retencao-timeline-chart"></canvas></div><div id="timeline-retencao-legend" class="custom-legend"></div>
            </div>
            <div class="lg:col-span-2 border chart-border rounded-xl p-6 flex flex-col">
                <h2 class="text-lg font-semibold text-white mb-2 text-center">CONTRATADOS X RETENÇÃO</h2>
                <div id="bar-chart-day-buttons" class="flex justify-center items-center flex-wrap gap-2 mb-4"></div>
                <div id="comparison-indicators" class="flex justify-center flex-wrap gap-4 mb-4"></div>
                <div class="relative flex-grow h-64"><canvas id="contratados-retencao-bar-chart"></canvas></div>
            </div>
            <div class="border chart-border rounded-xl p-6 flex flex-col">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4" id="controls-fac"><h2 class="text-lg font-semibold text-white">FACÇÕES EM FOCO</h2><div class="flex items-center space-x-2"><input type="text" readonly class="input-field p-1 text-sm text-center cursor-pointer litepicker-trigger" placeholder="Selecionar Período" style="width: 240px;"><button class="text-purple-400 border border-purple-400 rounded-lg py-1 px-3 text-sm font-semibold hover:bg-purple-400 hover:text-black transition-colors btn-anotacao" data-key="fac">ANOTAÇÃO</button><button class="text-white border border-gray-500 rounded-lg py-1 px-3 text-sm font-semibold btn-action btn-reset-chart">RESET</button></div></div>
                <div class="relative flex-grow h-64"><canvas id="fac-timeline-chart"></canvas></div><div id="timeline-fac-legend" class="custom-legend"></div>
            </div>
            <div id="status-semanal-fac" class="border chart-border rounded-xl p-6">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4"><h2 class="text-lg font-semibold text-white">STATUS SEMANAL FACS FOCO</h2><div class="flex items-center space-x-2"><input type="date" id="weekly-status-fac-date" class="input-field p-1 text-sm" title="Selecione um dia da semana"><button id="weekly-status-fac-reset" class="text-white border border-gray-500 rounded-lg py-1 px-3 text-sm font-semibold btn-action">RESET</button></div></div>
                <div class="space-y-3"></div>
            </div>
            <div id="status-semanal" class="border chart-border rounded-xl p-6">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4"><h2 class="text-lg font-semibold text-white">STATUS SEMANAL DAS PASTAS</h2><div class="flex items-center space-x-2"><input type="date" id="weekly-status-date" class="input-field p-1 text-sm" title="Selecione um dia da semana"><button id="weekly-status-reset" class="text-white border border-gray-500 rounded-lg py-1 px-3 text-sm font-semibold btn-action">RESET</button></div></div>
                <div class="space-y-3"></div>
            </div>
            <div class="border chart-border rounded-xl p-6 flex flex-col justify-between">
                <div><h2 class="text-lg font-semibold text-white mb-6">RANK DE PRÊMIOS (GERAL POR PASTA)</h2><div class="relative h-48 w-full"><canvas id="premios-pie-chart"></canvas></div></div>
                <button id="open-consult-modal-btn" class="w-full mt-6 bg-yellow-400 text-black font-bold py-3 rounded-lg hover:bg-yellow-500 transition-colors">CONSULTAR RANK DIÁRIO</button>
            </div>
        </main>
        
        <div class="mt-12 flex justify-center items-center gap-4">
            <button id="export-data-btn" class="text-white font-semibold py-2 px-6 rounded-lg btn-action">Exportar Dados</button>
            <button id="import-data-btn" class="text-white font-semibold py-2 px-6 rounded-lg btn-action">Importar Dados</button>
            <input type="file" id="import-file-input" class="hidden" accept=".json">
        </div>
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>TODOS DIREITOS RESERVADOS - SHEMIAH #S3LO - 2025</p>
        </footer>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
    // GARANTE QUE O SCRIPT RODE APENAS QUANDO A PÁGINA ESTIVER 100% CARREGADA
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- CONFIGURAÇÃO E AUTENTICAÇÃO ---
        const firebaseConfig = {
          apiKey: "AIzaSyCONofXx4NlCP34PZrs4pV-gDRJ_Uasw3c",
          authDomain: "wswallstreet-3ab24.firebaseapp.com",
          projectId: "wswallstreet-3ab24",
          storageBucket: "wswallstreet-3ab24.firebasestorage.app",
          messagingSenderId: "255776848131",
          appId: "1:255776848131:web:17af511729c29eb2569136"
        };
        
        const fbApp = firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.firestore();
        const ADMIN_EMAIL = 'kraznelofc@gmail.com';

        fbAuth.onAuthStateChanged(async (user) => {
            if (user) {
                // ... (código de verificação de admin)
                await initializeApp();
            } else {
                window.location.href = 'login.html';
            }
        });
        
        let db;
        const dbRef = fbDb.collection('application_data').doc('main');

        async function loadDb() {
            try {
                const doc = await dbRef.get();
                if (doc.exists && doc.data().dailyData) {
                    return doc.data();
                }
                return { dailyData: {}, premios: [], facData: {}, notes: {contratados: {}, retencao: {}, fac: {}} };
            } catch (error) {
                console.error("Erro fatal ao carregar dados do Firestore:", error);
                document.body.innerHTML = '<div class="text-white text-center p-10"><h1>Erro Crítico</h1><p>Não foi possível conectar ao banco de dados. Verifique a consola para mais detalhes.</p></div>';
                document.body.style.display = 'block'; // Garante que a mensagem de erro seja visível
                return null;
            }
        }

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        async function initializeApp() {
            db = await loadDb();
            if (!db) return; // Interrompe se o banco de dados falhar

            // Mostra o corpo da página agora que tudo está pronto para carregar
            document.body.style.display = 'block';

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('main-date-filter').value = today;
            // ... (inicialização de outros campos de data)

            setupDayButtons();
            setupDateRangePickers(); // <--- Inicia o Litepicker de forma segura
            
            // Cria os gráficos
            chartInstances.contratadosTimelineChart = createTimelineChart('contratados-timeline-chart', 'contratados');
            chartInstances.retencaoTimelineChart = createTimelineChart('retencao-timeline-chart', 'retencao');
            chartInstances.facTimelineChart = createFacTimelineChart();
            chartInstances.contratadosRetencaoBarChart = createContratadosRetencaoChart();
            chartInstances.premiosPieChart = createPieChart();
            
            updateAllCharts();
        }

        let chartInstances = {};
        const categories = [ { id: 'conexao', name: 'Conexão', color: 'cyan', hex: '#22d3ee' }, /* ... outras categorias ... */ ];
        
        // --- LÓGICA DE GRÁFICOS ---
        // (Funções de criação de gráficos como createTimelineChart, createPieChart, etc., permanecem as mesmas do seu código original)

        // ATUALIZADO: Lógica do gráfico de barras
        const updateContratadosRetencaoChart = (date) => {
            updateComparisonIndicators(date); 
            const dataForDay = db.dailyData?.[date] || {};
            const chart = chartInstances.contratadosRetencaoBarChart;
            if (chart) {
                chart.data.datasets[0].data = categories.map(cat => dataForDay[cat.id]?.contratados || 0);
                chart.data.datasets[1].data = categories.map(cat => dataForDay[cat.id]?.retencao || 0);
                chart.update();
            }
            updateActiveDayButton(date);
        };
        
        // ATUALIZADO: Indicadores agora mostram "Aguardando dados"
        const updateComparisonIndicators = (dateString) => {
            const container = document.getElementById('comparison-indicators');
            container.innerHTML = '';
            if (!dateString || !db.dailyData) return;

            const currentDataForDay = db.dailyData[dateString];
            if (!currentDataForDay) {
                container.innerHTML = `<div class="text-sm text-gray-500 italic">Aguardando dados para o cálculo.</div>`;
                return;
            }
            // ... (o resto da função para calcular e criar o indicador continua o mesmo do seu código original)
        };
        
        // ATUALIZADO: Lógica definitiva para os botões de dia da semana
        const setupDayButtons = () => {
            const container = document.getElementById('bar-chart-day-buttons');
            const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
            const dayIndices = [1, 2, 3, 4, 5, 6, 0]; 
            container.innerHTML = days.map((day, index) => `<button class="day-btn px-3 py-1 text-xs rounded-md btn-action" data-day-index="${dayIndices[index]}">${day}</button>`).join('');
            
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('day-btn')) {
                    const mainDateVal = document.getElementById('main-date-filter').value;
                    if (!mainDateVal) return;
                    
                    const mainDate = new Date(`${mainDateVal}T12:00:00Z`);
                    const targetDayIndex = parseInt(e.target.dataset.dayIndex, 10);
                    
                    const dayOfWeek = mainDate.getUTCDay(); // 0 para Dom, 1 para Seg...
                    const daysToMonday = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;
                    
                    const mondayOfRelevantWeek = new Date(mainDate);
                    mondayOfRelevantWeek.setUTCDate(mondayOfRelevantWeek.getUTCDate() - daysToMonday);
                    
                    const dayOffset = dayIndices.indexOf(targetDayIndex);
                    
                    const targetDate = new Date(mondayOfRelevantWeek);
                    targetDate.setUTCDate(targetDate.getUTCDate() + dayOffset);

                    const targetDateString = targetDate.toISOString().split('T')[0];
                    updateContratadosRetencaoChart(targetDateString);
                }
            });
        };
        
        const updateActiveDayButton = (dateString) => { /* ... (mesma função do seu código) */ };
        
        // ATUALIZADO: Lógica para o seletor de datas Litepicker
        const applyDateFilter = (chart, start, end) => { if (chart && start && end) { chart.options.scales.x.min = start; chart.options.scales.x.max = end; chart.update(); } };
        const resetZoomAndFilter = (chart) => { if (chart) { delete chart.options.scales.x.min; delete chart.options.scales.x.max; chart.resetZoom(); } };

        const setupDateRangePickers = () => {
            document.querySelectorAll('.litepicker-trigger').forEach(el => {
                const picker = new Litepicker({
                    element: el,
                    singleMode: false,
                    format: 'DD/MM/YYYY',
                    lang: 'pt-BR',
                    numberOfMonths: 2,
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            const controlsDiv = el.closest('[id^="controls-"]');
                            const key = controlsDiv.id.split('-')[1];
                            const chart = chartInstances[`${key}TimelineChart`];
                            const start = date1.format('YYYY-MM-DD');
                            const end = date2.format('YYYY-MM-DD');
                            applyDateFilter(chart, start, end);
                        });
                    }
                });
                el.litepickerInstance = picker;
            });
        };
        
        document.querySelectorAll('.btn-reset-chart').forEach(btn => btn.addEventListener('click', (e) => {
            const controlsDiv = e.target.closest('[id^="controls-"]');
            const pickerInput = controlsDiv.querySelector('.litepicker-trigger');
            if (pickerInput && pickerInput.litepickerInstance) {
                pickerInput.litepickerInstance.clearSelection();
            }
            const key = controlsDiv.id.split('-')[1];
            const chart = chartInstances[`${key}TimelineChart`];
            resetZoomAndFilter(chart);
        }));

        document.getElementById('main-date-filter').addEventListener('change', (e) => {
            updateContratadosRetencaoChart(e.target.value);
            // ... (outras atualizações de status que dependem da data principal)
        });

        // ... (resto do seu código original para modais, import/export, etc., que já funcionava)

    }); // FIM DO DOMCONTENTLOADED
    </script>
</body>
</html>
